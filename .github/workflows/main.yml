name: Susak Python CI

# Определяем, когда запускать workflow
on:
  push:
    branches:
      - main  # Запускать workflow при push в основную ветку
  workflow_dispatch:  # Позволяет запускать workflow вручную через интерфейс GitHub

# Определяем задачи
jobs:
  build:
    # Используем общедоступный runner Ubuntu
    runs-on: ubuntu-latest
    
    # Шаги для выполнения
    steps:
      # Клонирование репозитория
      - name: Checkout code
        uses: actions/checkout@v3

      # Установка Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'  # Указываем версию Python 3.10, как требуется

      # Установка зависимостей
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Выполнение скрипта для создания/обновления базы данных
      - name: Run db.py script to initialize the database
        run: python db.py --add_default_data

      # Запуск приложения
      - name: Run the API
        run: nohup python app.py --host 0.0.0.0 --port 5000 & echo $! > api.pid 

      # Проверка, что API работает корректно
      - name: Test API endpoint
        run: curl --fail http://0.0.0.0:5000/api/products
      # Добавление продукта для тестирования
      - name: Add a test product
        run: |
          curl -X POST http://0.0.0.0:5000/api/products -H "Content-Type: application/json" -d '{"name": "Eggs", "price": 12}'

      # Проверка, что продукт доступен по ID
      - name: Test API endpoint for a specific product
        run: curl --fail http://0.0.0.0:5000/api/products/6

        
        
      # Остановка сервера Flask
      - name: Stop the API
        run: kill $(cat api.pid)
